<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ‘æ©˜åœ’æ™ºèƒ½çŒæº‰è¨ˆç®—ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #28a745;
            --secondary-color: #17a2b8;
            --accent-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        body { 
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8e9 100%);
            font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh;
        }
        
        .main-container { 
            max-width: 1400px; 
            background: white; 
            border-radius: 15px; 
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .header-section h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
        }
        
        .header-section p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }
        
        .form-section { 
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem; 
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .form-section:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .form-section h4 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .form-section h4 i {
            margin-right: 0.5rem;
        }
        
        .parameter-description {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 0.25rem;
            font-style: italic;
        }
        
        .btn-calculate {
            background: linear-gradient(45deg, var(--primary-color), #20c997);
            border: none;
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
            font-weight: 500;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .results-container {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .stage-info {
            background: linear-gradient(135deg, #e8f5e8, #f0f8ff);
            border-left: 4px solid var(--primary-color);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        
        .result-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .result-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 500;
            border: none;
        }
        
        .irrigation-advice {
            background: linear-gradient(135deg, #d4edda, #cce7ff);
            border: 1px solid #b8daff;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .irrigation-advice.no-irrigation {
            background: linear-gradient(135deg, #fff3cd, #f8d7da);
            border-color: #ffeaa7;
        }
        
        .calculation-details {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .water-need-indicator {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }
        
        .water-need-low { background: #d1ecf1; color: #0c5460; }
        .water-need-medium { background: #fff3cd; color: #856404; }
        .water-need-high { background: #f8d7da; color: #721c24; }
        
        .progress-bar-container {
            margin: 1rem 0;
        }
        
        .alert-custom {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .header-section h1 { font-size: 2rem; }
            .main-container { margin: 1rem; }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="main-container mx-auto">
            <!-- æ¨™é¡Œå€åŸŸ -->
            <div class="header-section">
                <h1><i class="fas fa-seedling"></i> æŸ‘æ©˜åœ’æ™ºèƒ½çŒæº‰è¨ˆç®—ç³»çµ±</h1>
                <p>åŸºæ–¼ç§‘å­¸æ°´åˆ†å¹³è¡¡æ¨¡å‹çš„ç²¾æº–çŒæº‰ç®¡ç†å·¥å…·</p>
            </div>
            
            <div class="p-4">
                <form id="irrigationForm">
                    <!-- åŸºæœ¬åƒæ•¸è¨­å®š -->
                    <div class="form-section">
                        <h4><i class="fas fa-cog"></i> åŸºæœ¬åƒæ•¸è¨­å®š</h4>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-calendar-alt"></i> è¨ˆç®—æ—¥æœŸ
                                    </label>
                                    <input type="date" class="form-control" id="calculationDate" required>
                                    <div class="parameter-description">é¸æ“‡éœ€è¦è¨ˆç®—çŒæº‰å»ºè­°çš„ç›®æ¨™æ—¥æœŸ</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-leaf"></i> ç•¶å‰ç”Ÿè‚²æœŸ
                                    </label>
                                    <select class="form-select" id="growthStage" required>
                                        <option value="">è«‹é¸æ“‡ç•¶å‰ç”Ÿè‚²æœŸ</option>
                                        <option value="flowerBud">ğŸŒ¸ èŠ±èŠ½åˆ†åŒ–æœŸ (éœ€æ°´é‡ä½)</option>
                                        <option value="springFlush">ğŸŒ± æ˜¥æ¢¢èŒç™¼æœŸ (éœ€æ°´é‡ä¸­)</option>
                                        <option value="fruitDev">ğŸŠ è‘—æœåŠæœå¯¦ç™¼è‚²æœŸ (éœ€æ°´é‡é«˜)</option>
                                        <option value="harvest">ğŸ¯ æœå¯¦è½‰è‰²è‡³æ¡æ”¶æœŸ (éœ€æ°´é‡ä¸­)</option>
                                        <option value="dormant">ğŸ˜´ ä¼‘çœ æœŸ (éœ€æ°´é‡ä½)</option>
                                    </select>
                                    <div class="parameter-description">æ ¹æ“šç”°é–“å¯¦éš›è§€å¯Ÿé¸æ“‡ç•¶å‰ä¸»è¦ç”Ÿè‚²æœŸ</div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-tree"></i> æ¨¹é½¡ (å¹´)
                                            </label>
                                            <input type="number" class="form-control" id="treeAge" min="1" max="50" required>
                                            <div class="parameter-description">å½±éŸ¿ä½œç‰©ä¿‚æ•¸(Kc)çš„é‡è¦å› å­</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-th"></i> ç¨®æ¤å¯†åº¦
                                            </label>
                                            <select class="form-select" id="plantingDensity">
                                                <option value="high">é«˜å¯†åº¦ (â‰¥200æ ª/å…¬é ƒ)</option>
                                                <option value="low">ä½å¯†åº¦ (<200æ ª/å…¬é ƒ)</option>
                                            </select>
                                            <div class="parameter-description">å½±éŸ¿æ•´é«”åœ’å€è’¸ç™¼æ•£é‡</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-mountain"></i> åœŸå£¤è³ªåœ°
                                    </label>
                                    <select class="form-select" id="soilType" required>
                                        <option value="0.47">ğŸ–ï¸ ç ‚åœŸ (0.47 mm/cm)</option>
                                        <option value="1.28">ğŸŒ¾ ç ‚å£¤åœŸ (1.28 mm/cm)</option>
                                        <option value="1.92" selected>ğŸŒ± å£¤åœŸ (1.92 mm/cm) - æ¨è–¦</option>
                                        <option value="2.23">ğŸŒ¿ ç å£¤åœŸ (2.23 mm/cm)</option>
                                        <option value="2.33">ğŸƒ é»å£¤åœŸ (2.33 mm/cm)</option>
                                        <option value="2.30">ğŸŒ° ç é»åœŸ (2.30 mm/cm)</option>
                                        <option value="2.30">ğŸ§± é»åœŸ (2.30 mm/cm)</option>
                                    </select>
                                    <div class="parameter-description">æ±ºå®šåœŸå£¤ç”°é–“å®¹æ°´é‡çš„é—œéµåƒæ•¸</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-ruler-vertical"></i> æœ‰æ•ˆæ ¹ç³»æ·±åº¦ (cm)
                                    </label>
                                    <input type="number" class="form-control" id="rootDepth" min="20" max="150" value="80" required>
                                    <div class="parameter-description">æˆå¹´æŸ‘æ©˜æ¨¹é€šå¸¸ç‚º60-100cm</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç®¡ç†ç­–ç•¥è¨­å®š -->
                    <div class="form-section">
                        <h4><i class="fas fa-tachometer-alt"></i> æ°´åˆ†ç®¡ç†ç­–ç•¥</h4>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-droplet"></i> åœŸå£¤æ°´åˆ†æ§åˆ¶ç›®æ¨™
                                    </label>
                                    <select class="form-select" id="managementTarget" required>
                                        <option value="wet">ğŸ’§ æ¿•æ½¤ç®¡ç† (25 kPa) - ç”Ÿé•·ç™¼è‚²æœŸ</option>
                                        <option value="suitable" selected>âš–ï¸ é©ä¸­ç®¡ç† (40 kPa) - ä¸€èˆ¬æ¨è–¦</option>
                                        <option value="slightDry">ğŸŒ¤ï¸ ç•¥ä¹¾ç®¡ç† (60 kPa) - å“è³ªæå‡æœŸ</option>
                                        <option value="controlled">ğŸ¯ æ§åˆ¶ç®¡ç† (100 kPa) - æ§åˆ¶å¾’é•·</option>
                                    </select>
                                    <div class="parameter-description">æ ¹æ“šç”Ÿè‚²æœŸç‰¹æ€§å’Œç®¡ç†ç›®æ¨™é¸æ“‡</div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-shower"></i> çŒæº‰ç³»çµ±é¡å‹
                                    </label>
                                    <select class="form-select" id="irrigationType" required>
                                        <option value="sprinkler">ğŸŒ§ï¸ å™´çŒç³»çµ± (æ•ˆç‡85%)</option>
                                        <option value="microSpray" selected>ğŸ’¦ å¾®å™´/éœ§çŒ (æ•ˆç‡90%)</option>
                                        <option value="drip">ğŸ’§ æ»´çŒç³»çµ± (æ•ˆç‡95%)</option>
                                    </select>
                                    <div class="parameter-description">ä¸åŒç³»çµ±çš„æ°´åˆ†åˆ©ç”¨æ•ˆç‡å·®ç•°é¡¯è‘—</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç•¶æ—¥æ•¸æ“šè¼¸å…¥ -->
                    <div class="form-section">
                        <h4><i class="fas fa-database"></i> ç•¶æ—¥ç›£æ¸¬æ•¸æ“š</h4>
                        <div class="row">
                            <div class="col-lg-4">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-chart-line"></i> å‰æ—¥åœŸå£¤è€—æ°´é‡ D[x-1] (mm)
                                    </label>
                                    <input type="number" class="form-control" id="previousDeficit" step="0.1" value="25" required>
                                    <div class="parameter-description">å‰ä¸€å¤©ç´¯ç©çš„åœŸå£¤æ°´åˆ†è™§ç¼ºé‡</div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-cloud-rain"></i> ç•¶æ—¥é™é›¨é‡ (mm)
                                    </label>
                                    <input type="number" class="form-control" id="rainfall" step="0.1" value="0" required>
                                    <div class="parameter-description">å¯¦æ¸¬æˆ–æ°£è±¡é å ±çš„é™é›¨é‡</div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-thermometer-half"></i> é ä¼°åƒè€ƒè’¸ç™¼æ•£é‡ (mm)
                                    </label>
                                    <input type="number" class="form-control" id="customETo" step="0.1" placeholder="è‡ªå‹•è¨ˆç®—">
                                    <div class="parameter-description">å¯æ‰‹å‹•è¼¸å…¥ï¼Œå¦å‰‡ç³»çµ±è‡ªå‹•è¨ˆç®—</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è¨ˆç®—æŒ‰éˆ• -->
                    <div class="text-center mb-4">
                        <button type="button" class="btn btn-primary btn-calculate" onclick="calculateIrrigation()">
                            <i class="fas fa-calculator"></i> é–‹å§‹è¨ˆç®—çŒæº‰å»ºè­°
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-3" onclick="resetForm()">
                            <i class="fas fa-redo"></i> é‡ç½®è¡¨å–®
                        </button>
                    </div>
                </form>

                <!-- è¨ˆç®—çµæœå€åŸŸ -->
                <div id="results" class="results-container" style="display: none;">
                    <h4 class="text-primary mb-3">
                        <i class="fas fa-chart-bar"></i> è¨ˆç®—çµæœèˆ‡å»ºè­°
                    </h4>
                    
                    <!-- ç”Ÿè‚²æœŸè³‡è¨Š -->
                    <div class="stage-info" id="growthStageInfo"></div>
                    
                    <!-- æ°´åˆ†ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
                    <div class="progress-bar-container">
                        <label class="form-label fw-bold">åœŸå£¤æ°´åˆ†ç‹€æ…‹æŒ‡ç¤ºå™¨</label>
                        <div class="progress" style="height: 25px;">
                            <div id="waterStatusBar" class="progress-bar" role="progressbar"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-success">å……è¶³</small>
                            <small class="text-warning">é©ä¸­</small>
                            <small class="text-danger">ä¸è¶³</small>
                        </div>
                    </div>
                    
                    <!-- çµæœè¡¨æ ¼ -->
                    <div class="table-responsive">
                        <table class="table table-hover result-table">
                            <thead>
                                <tr>
                                    <th width="25%">è¨ˆç®—é …ç›®</th>
                                    <th width="15%">æ•¸å€¼</th>
                                    <th width="10%">å–®ä½</th>
                                    <th width="50%">èªªæ˜</th>
                                </tr>
                            </thead>
                            <tbody id="resultTable"></tbody>
                        </table>
                    </div>
                    
                    <!-- çŒæº‰å»ºè­° -->
                    <div id="irrigationAdvice" class="irrigation-advice"></div>
                    
                    <!-- è¨ˆç®—ç´°ç¯€ -->
                    <div class="mt-3">
                        <button class="btn btn-outline-info btn-sm" onclick="toggleCalculationDetails()">
                            <i class="fas fa-info-circle"></i> é¡¯ç¤º/éš±è—è¨ˆç®—éç¨‹
                        </button>
                        <div id="calculationDetails" class="calculation-details mt-2" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ç³»çµ±å¸¸æ•¸å®šç¾©
        const SYSTEM_CONSTANTS = {
            ETO_BASE: 4.5,          // åŸºæº–åƒè€ƒè’¸ç™¼æ•£é‡ (mm/day)
            ETO_VARIATION: 2.0,     // å­£ç¯€è®ŠåŒ–å¹…åº¦
            INr: 3.0,               // æ¤ç‰©æˆªç•™é‡ (mm)
            BASE_IRRIGATION: 8,     // åŸºæº–çŒæº‰æ·±åº¦ (mm)
            MAX_IRRIGATION: 25,     // æœ€å¤§å–®æ¬¡çŒæº‰é‡ (mm)
            MIN_IRRIGATION: 3       // æœ€å°çŒæº‰é‡ (mm)
        };

        // ç”Ÿè‚²æœŸç‰¹æ€§å®šç¾©
        const GROWTH_STAGES = {
            'flowerBud': {
                name: 'èŠ±èŠ½åˆ†åŒ–æœŸ',
                icon: 'ğŸŒ¸',
                cd: 'd',
                baseKc: 0.30,
                description: 'ç¶­æŒé©åº¦ä¹¾ç‡¥æœ‰åˆ©æ–¼èŠ±èŠ½åˆ†åŒ–ï¼Œé¿å…éåº¦çŒæº‰',
                waterNeed: 'low',
                tips: ['æ§åˆ¶æ°´åˆ†é¿å…å¾’é•·', 'ä¿ƒé€²èŠ±èŠ½åˆ†åŒ–', 'æ¸›å°‘ç—…å®³ç™¼ç”Ÿ']
            },
            'springFlush': {
                name: 'æ˜¥æ¢¢èŒç™¼æœŸ',
                icon: 'ğŸŒ±',
                cd: 'd',
                baseKc: 0.50,
                description: 'æ–°æ¢¢ç”Ÿé•·éœ€è¦é©åº¦æ°´åˆ†ï¼Œä¿æŒåœŸå£¤æ¿•æ½¤ä½†ä¸éæ¿•',
                waterNeed: 'medium',
                tips: ['æ”¯æŒæ–°æ¢¢å¥åº·ç”Ÿé•·', 'é¿å…æ°´åˆ†è„…è¿«', 'ä¿ƒé€²è‘‰ç‰‡å±•é–‹']
            },
            'fruitDev': {
                name: 'è‘—æœåŠæœå¯¦ç™¼è‚²æœŸ',
                icon: 'ğŸŠ',
                cd: 'c',
                baseKc: 0.85,
                description: 'æœå¯¦ç™¼è‚²é—œéµæœŸï¼Œéœ€è¦å……è¶³ç©©å®šçš„æ°´åˆ†ä¾›æ‡‰',
                waterNeed: 'high',
                tips: ['ç¢ºä¿æœå¯¦æ­£å¸¸ç™¼è‚²', 'é˜²æ­¢è½æœ', 'ç¶­æŒç©©å®šä¾›æ°´']
            },
            'harvest': {
                name: 'æœå¯¦è½‰è‰²è‡³æ¡æ”¶æœŸ',
                icon: 'ğŸ¯',
                cd: 'c',
                baseKc: 0.65,
                description: 'é©åº¦æ§åˆ¶æ°´åˆ†æœ‰åˆ©æ–¼æœå¯¦å“è³ªæå‡å’Œç³–åˆ†ç´¯ç©',
                waterNeed: 'medium',
                tips: ['æå‡æœå¯¦å“è³ª', 'ä¿ƒé€²ç³–åˆ†ç´¯ç©', 'æ§åˆ¶æœå¯¦å¤§å°']
            },
            'dormant': {
                name: 'ä¼‘çœ æœŸ',
                icon: 'ğŸ˜´',
                cd: 'd',
                baseKc: 0.30,
                description: 'ç¶­æŒåŸºæœ¬éœ€æ°´é‡ï¼Œå¯é©åº¦æ§åˆ¶çŒæº‰é »ç‡',
                waterNeed: 'low',
                tips: ['ç¶­æŒåŸºæœ¬ç”Ÿç†éœ€æ±‚', 'æº–å‚™ä¸‹ä¸€å­£ç”Ÿé•·', 'ç¯€ç´„ç”¨æ°´']
            }
        };

        // åœŸå£¤æ°´åˆ†ç®¡ç†åƒæ•¸
        const MANAGEMENT_TARGETS = {
            'wet': { 
                tension: 25, 
                c: 0.30, 
                d: 0.32,
                name: 'æ¿•æ½¤ç®¡ç†',
                description: 'é©åˆç”Ÿé•·ç™¼è‚²æ—ºç››æœŸä½¿ç”¨',
                color: '#28a745'
            },
            'suitable': { 
                tension: 40, 
                c: 0.35, 
                d: 0.40,
                name: 'é©ä¸­ç®¡ç†',
                description: 'ä¸€èˆ¬æƒ…æ³ä¸‹çš„æ¨è–¦ç®¡ç†æ–¹å¼',
                color: '#17a2b8'
            },
            'slightDry': { 
                tension: 60, 
                c: 0.45, 
                d: 0.45,
                name: 'ç•¥ä¹¾ç®¡ç†',
                description: 'é©åˆæœå¯¦ç™¼è‚²å¾ŒæœŸå“è³ªæå‡',
                color: '#ffc107'
            },
            'controlled': { 
                tension: 100, 
                c: 0.45, 
                d: 0.57,
                name: 'æ§åˆ¶ç®¡ç†',
                description: 'ç”¨æ–¼æ§åˆ¶å¾’é•·å’Œæé«˜æŠ—é€†æ€§',
                color: '#fd7e14'
            }
        };

        // çŒæº‰ç³»çµ±åƒæ•¸
        const IRRIGATION_SYSTEMS = {
            'sprinkler': { 
                efficiency: 0.85, 
                INi: 2.0,
                name: 'å™´çŒç³»çµ±',
                description: 'é©åˆå¤§é¢ç©å‡å‹»çŒæº‰ï¼Œæˆæœ¬è¼ƒä½'
            },
            'microSpray': { 
                efficiency: 0.90, 
                INi: 1.0,
                name: 'å¾®å™´/éœ§çŒ',
                description: 'é©åˆå±€éƒ¨ç²¾æº–çŒæº‰ï¼Œæ•ˆç‡è¼ƒé«˜'
            },
            'drip': { 
                efficiency: 0.95, 
                INi: 0.5,
                name: 'æ»´çŒç³»çµ±',
                description: 'æœ€ç¯€æ°´çš„çŒæº‰æ–¹å¼ï¼Œç²¾æº–æ§åˆ¶'
            }
        };

        // åˆå§‹åŒ–è¡¨å–®
        function initializeForm() {
            // è¨­å®šç•¶å‰æ—¥æœŸ
            document.getElementById('calculationDate').valueAsDate = new Date();
        }

        // è¨ˆç®—å¹´å…§å¤©æ•¸
        function getDayOfYear(date) {
            const start = new Date(date.getFullYear(), 0, 0);
            const diff = date - start;
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay);
        }

        // è¨ˆç®—åƒè€ƒè’¸ç™¼æ•£é‡ (ETo)
        function calculateETo(dayOfYear, customValue = null) {
            if (customValue !== null && customValue > 0) {
                return customValue;
            }
            
            // ä½¿ç”¨æ­£å¼¦å‡½æ•¸æ¨¡æ“¬å­£ç¯€è®ŠåŒ–
            const seasonalFactor = Math.sin((dayOfYear - 80) * 2 * Math.PI / 365) * 0.5 + 1;
            const eto = SYSTEM_CONSTANTS.ETO_BASE * seasonalFactor;
            
            // é™åˆ¶åœ¨åˆç†ç¯„åœå…§
            return Math.max(2, Math.min(8, eto));
        }

        // è¨ˆç®—ä½œç‰©ä¿‚æ•¸ (Kc)
        function calculateKc(baseKc, treeAge, plantingDensity) {
            let ageAdjustment = 1.0;
            
            // æ¨¹é½¡èª¿æ•´ä¿‚æ•¸
            if (treeAge <= 3) {
                ageAdjustment = 0.5 + (treeAge * 0.1);
            } else if (treeAge <= 8) {
                ageAdjustment = 0.8 + ((treeAge - 3) * 0.04);
            } else if (treeAge <= 15) {
                ageAdjustment = 1.0;
            } else {
                ageAdjustment = 1.0 - ((treeAge - 15) * 0.01);
            }

            // ç¨®æ¤å¯†åº¦èª¿æ•´
            const densityFactor = plantingDensity === 'high' ? 1.15 : 1.0;

            return Math.max(0.2, Math.min(1.5, baseKc * ageAdjustment * densityFactor));
        }

        // è¨ˆç®—æ°´åˆ†è„…è¿«ä¿‚æ•¸ (Ks)
        function calculateKs(Fc, D_prev) {
            const threshold = Fc * 0.65; // è¨­å®šè„…è¿«é–‹å§‹é»
            
            if (D_prev <= threshold) {
                return 1.0;
            } else {
                const ks = Math.max(0.1, (Fc - D_prev) / (Fc - threshold));
                return Math.min(1.0, ks);
            }
        }

        // è¨ˆç®—æœ‰æ•ˆé›¨é‡
        function calculateEffectiveRainfall(rainfall, D_prev, ETc) {
            if (rainfall <= SYSTEM_CONSTANTS.INr) {
                return 0;
            }
            
            const netRainfall = rainfall - SYSTEM_CONSTANTS.INr;
            const maxEffective = D_prev + ETc;
            
            return Math.min(netRainfall, maxEffective);
        }

        // è¨ˆç®—ç®¡ç†å®¹è¨±è€—æ°´é‡ (RAM)
        function calculateRAM(growthStage, Fc, managementTarget) {
            const stageInfo = GROWTH_STAGES[growthStage];
            const targetInfo = MANAGEMENT_TARGETS[managementTarget];
            
            const coefficient = stageInfo.cd === 'c' ? targetInfo.c : targetInfo.d;
            
            return Math.min(Fc * coefficient, Fc * 0.8);
        }

        // è¨ˆç®—çŒæº‰é‡
        function calculateIrrigationAmount(D, RAM, irrigationType) {
            if (D <= RAM) {
                return 0;
            }
            
            const system = IRRIGATION_SYSTEMS[irrigationType];
            const deficit = D - RAM;
            
            // è€ƒæ…®ç³»çµ±æ•ˆç‡
            let grossIrrigation = deficit / system.efficiency + system.INi;
            
            // èª¿æ•´åˆ°åˆç†ç¯„åœ
            grossIrrigation = Math.max(SYSTEM_CONSTANTS.MIN_IRRIGATION, grossIrrigation);
            grossIrrigation = Math.min(SYSTEM_CONSTANTS.MAX_IRRIGATION, grossIrrigation);
            
            return Math.round(grossIrrigation * 10) / 10;
        }

        // ä¸»è¦è¨ˆç®—å‡½æ•¸
        function calculateIrrigation() {
            try {
                // ç²å–è¼¸å…¥åƒæ•¸
                const inputs = getInputValues();
                if (!validateInputs(inputs)) return;

                // åŸ·è¡Œè¨ˆç®—
                const results = performCalculations(inputs
